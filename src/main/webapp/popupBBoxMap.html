<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" />
	<style type="text/css">
		* {
			padding: 0;
			margin: 0;
		}
		#map {
			position: absolute;
			width: 100%;
			height: 100%;
			bottom: 0;

		}
		#helper {
			font-size: 2em;
			position: absolute;
			bottom: 0;
			width: 100%;
			z-index: 5000;
		}
	</style>
</head>
<body>
	<div id="map"></div>
	<div id="helper">
		Press Ctrl to draw the bounding box, click on it to validate.
	</div>
	<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"></script>
	<script type="text/javascript">
		var map;
		var layerOpts = {
     	   	color: '#FF6666',
        	weight: 5,
        	opacity: 0.8,
		}
		window.addEventListener('load',function(){
			map = L.map("map").setView([0,0],1)
			L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
    			attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com">Carto.com</a>'
			}).addTo(map);
			
			var bboxLayer;
            var points=[];
            
            // Parse bbox in GET params
            var url = new URL(window.location.href);
            if (url.searchParams.get('bbox') != null){
                bbox = url.searchParams.get('bbox').split(';')
                if (bbox.length == 4){
                    bboxLayer = L.rectangle([[bbox[0],bbox[1]],[bbox[2],bbox[3]]],layerOpts).addTo(map)
                    map.fitBounds(bboxLayer.getBounds(),{maxZoom:3})
                }
            }

            // Draw feature
			var drawing = false;
			map.on('mousedown', function(e){
				if (e.originalEvent.ctrlKey == true){
					console.log("Start drawing")
					map.dragging.disable()
					drawing = true
					if (map.hasLayer(bboxLayer)){
						map.removeLayer(bboxLayer)
					}
					points[0] = e.latlng;
					points[1] = e.latlng;
					bboxLayer = L.rectangle(L.latLngBounds(points),layerOpts).addTo(map)
				}
			})
			map.on('mousemove', function(e){
				if (drawing){
					console.log("drawing")
					L.DomEvent.stopPropagation(e.originalEvent);
					points[1] = e.latlng;
					bboxLayer.setBounds(L.latLngBounds(points))
				}
			})
			map.on('mouseup mouseout', function(e){
				if (drawing){
					console.log("Stop drawing")
					L.DomEvent.stopPropagation(e.originalEvent);
					points[1] = e.latlng;
					bboxLayer.setBounds(L.latLngBounds(points))
					bboxLayer.on('click', function(){
						var bbox = bboxLayer.getBounds()
						bbox = {east: bbox.getEast(), west: bbox.getWest(), north: bbox.getNorth(), south: bbox.getSouth()}
						console.log(bbox)
						if (opener !== undefined && opener.DvMapPopupCallback !== undefined){
							opener.DvMapPopupCallback(bbox)	
							window.close()
						}
					})
				}
				map.dragging.enable()
				drawing = false
			})
		})
	</script>
</body>
</html>